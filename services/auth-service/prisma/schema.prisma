generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                       Int       @id @default(autoincrement())
  email                    String    @unique
  name                     String
  password                 String
  number                   String    @unique
  walletID                 String?
  address                  String?
  country                  String?
  createdAt                DateTime  @default(now())
  dob                      DateTime?
  state                    String?
  // Email Verification
  emailVerified            Boolean   @default(false)
  verificationToken        String?   @unique
  verificationTokenExpires DateTime?
  // Password Reset Token
  resetToken               String?   @unique
  resetTokenExpires        DateTime?
  // Security & Audit
  lastLoginAt              DateTime?
  failedLoginAttempts      Int       @default(0)
  lockedUntil              DateTime?
  passwordChangedAt        DateTime  @default(now())
  isActive                 Boolean   @default(true)
  isDeleted                Boolean   @default(false)
  role                     UserRole  @default(USER)
  twoFactorEnabled         Boolean   @default(false)
  twoFactorSecret          String?

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

// Audit log for security events
model SecurityLog {
  id        String            @id @default(cuid())
  userId    String?
  email     String?
  eventType SecurityEventType
  ipAddress String?
  userAgent String?
  success   Boolean
  metadata  Json?
  createdAt DateTime          @default(now())

  @@index([eventType])
  @@index([userId, eventType])
  @@map("security_logs")
}

enum SecurityEventType {
  LOGIN_ATTEMPT
  LOGIN_SUCCESS
  LOGIN_FAILURE

  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_SUCCESS
  PASSWORD_RESET_FAILURE

  PASSWORD_CHANGE_REQUEST
  PASSWORD_CHANGE_SUCCESS
  PASSWORD_CHANGE_FAILURE

  EMAIL_VERIFICATION
  EMAIL_VERIFICATION_SUCCESS
  EMAIL_VERIFICATION_FAILURE

  ACCOUNT_LOCKED
  SUSPICIOUS_ACTIVITY

  ACCOUNT_DEACTIVATION_SUCCESS
  ACCOUNT_DEACTIVATION_FAILURE

  ACCOUNT_DELETION_SUCCESS
  ACCOUNT_DELETION_FAILURE

  LOGOUT_ATTEMPT
  LOGOUT_SUCCESS
  LOGOUT_FAILURE

  SERVICE_AUTH_SUCCESS
  SERVICE_AUTH_FAILURE

  EMAIL_UPDATE_SUCCESS
  EMAIL_UPDATE_FAILURE

  PHONE_UPDATE_SUCCESS
  PHONE_UPDATE_FAILURE
}

// Session management for future JWT tokens
model Session {
  id        String   @id @default(cuid())
  userId    String
  sessionID String   @unique
  token     String   @unique
  expiresAt DateTime
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  @@index([userId, isActive])
  @@index([expiresAt])
  @@map("sessions")
}
